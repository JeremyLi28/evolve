<!DOCTYPE HTML>
<html>

<!--
The MIT License

Copyright (c) 2008-2011 AlteredQualia

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

Contributions:

2008-12-26 - Fritz Webering - added Gaussian mutations
2008-12-16 - Martin Breidt  - updated to export SVG data from DNA

-->

<head>
<title>Image evolution</title>

<style>
aaa { outline:dotted 1px red }
body { font-family:arial, sans-serif; padding:1em }
h2 { margin-top:1.75em }
canvas { border:solid 1px #000 }
.image { float:left; margin:0 0.5em 0 0; font-size:2em }
.clr { clear:both }
ul { list-style-type:square }
a:hover { background:#1e4881; color:white; text-decoration:none }

#algo, #dnaformat { background:#eee; padding:1em; margin-top:1em; border-left:solid 10px #999 }

.snapshot ul, .snapshot img { float:left }
.snapshot ul { margin:0 1em 1.5em 0; color:#333; width:13em }
.wide ul { width:30em }

#fitwrap { font-weight:bold; font-size:1em; color:#999; margin:2em 1em 0 0; float:left; width:15em }
#fitness, #step_benefit, #step_total { font-size:2em;}
#fitness { color:#000; }
#step_benefit { color:#0a0; }
#step_total { color:#aa0; }

#stats { font-size:0.8em; color:#aaa; float:left; position:relative; top:3em; margin-top:-2em }
#time { color:#a00 }
#mutsec { color:#a80 }

#start, #stop { width:4em; margin-top:0.5em; padding:0.5em; background:black; text-align:center; float:left; cursor:pointer; font-size:2em }
#start { color:lightgreen; }
#stop { color:red; display:none }

#imgform { float:left; border:solid 0px #000; padding:0em; margin:0.5em 1em 0 0; width:40em }
#imgurl { width:35em }

.button { background:#000; color:#fff; cursor:pointer; width:3em; padding:0.2em 0.5em 0.2em 0.5em; text-align:center; display:inline }
.button:hover { background:#a00; color:white }
.warning { color:red }
.highlighted { color:yellow }

#dnaformwrap { padding:0; float:left; margin:1em 1em 0 0; }
#clipboard { width:50em; height:13em; margin:1em 0 0 0 }

#mutationtype, #resetdna { margin:0 0 0.4em 0 }
#parameters { float:left; margin:2em 0 0 0 }
.parname { margin:0 0 0.2em 0 }

#geometry { margin:1em 0 0.4em 0 }
#polygons, #vertices { font-size:2em }
.pargeo { margin:0 0 0 0.5em; position:relative; top:0.4em }
#geometry .button { font-weight:bold; width:1em;  }

dt { font-weight:bold; margin-bottom:0.5em }
dd { margin:0 0 2em 0 }

.speed { font-size:0.9em; color:#60BF5F }
</style>

<script>
var IMG_INIT ="img/mona_lisa_crop.jpg"; // mona_lisa_crop.jpg mondrian.jpg
var DEPTH = 4;

var INIT_TYPE = "color"; // random color
var INIT_R = 0;
var INIT_G = 0;
var INIT_B = 0;
var INIT_A = 0.001;

var mutateDNA = genetic; // mutate_soft mutate_medium mutate_hard

var CANVAS_INPUT = 0;
var CANVAS_OUTPUT = 0;
var CANVAS_BEST = 0;

var CONTEXT_INPUT = 0;
var CONTEXT_TEST = 0;
var CONTEXT_BEST = 0;

var IMAGE = new Image();
var IWIDTH = 0;
var IHEIGHT = 0;
var SUBPIXELS = 0;

var EV_TIMEOUT = 0;
var EV_ID = 0;

var COUNTER_TOTAL = 0;
var COUNTER_BENEFIT = 0;

var LAST_COUNTER = 0;
var LAST_START = 0.0;
var ELAPSED_TIME = 0.0;

var EL_STEP_TOTAL = 0;
var EL_STEP_BENEFIT = 0;
var EL_FITNESS = 0;
var EL_ELAPSED_TIME = 0;
var EL_MUTSEC = 0;

var MAX_SHAPES = 50;    // max capacity
var MAX_POINTS = 6;

var ACTUAL_SHAPES = MAX_SHAPES; // current size
var ACTUAL_POINTS = MAX_POINTS;

var DNA_BEST = new Array(MAX_SHAPES);
var DNA_TEST = new Array(MAX_SHAPES);

var CHANGED_SHAPE_INDEX = 0;

var FITNESS_MAX = 999923400656;
var FITNESS_TEST = FITNESS_MAX;
var FITNESS_BEST = FITNESS_MAX;

var FITNESS_BEST_NORMALIZED = 0; // pixel match: 0% worst - 100% best
var NORM_COEF = IWIDTH*IHEIGHT*3*255; // maximum distance between black and white images

var DATA_INPUT = 0;
var DATA_TEST = 0;

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function hide(id) {
    var el = document.getElementById(id);
    if(el)
        el.style.display = "none";
}

function show(id) {
    var el = document.getElementById(id);
    if(el)
        el.style.display = "block";
}

function setElement(id, value) {
    var el = document.getElementById(id);
    if(el)
        el.innerHTML = value;
}

function setButtonHighlight(highlighted, others) {
    for(var i in others) {
        var el = document.getElementById(others[i]);
        if(el) {
            el.style.color = "white";
            el.style.background = "black";
        }
    }
    var elHighighted = document.getElementById(highlighted);
    if(elHighighted) {
        elHighighted.style.color = "white";
        elHighighted.style.background = "orange";
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function rand_int(maxval) {
    return Math.round(maxval*Math.random());
}

function rand_float(maxval) {
    return maxval*Math.random();
}

function clamp(val, minval, maxval) {
    if(val<minval) return minval;
    if(val>maxval) return maxval;
    return val;
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function stop() {
    clearTimeout(EV_ID);

    ELAPSED_TIME += get_timestamp() - LAST_START;

    hide("stop");
    show("start");
}

function start() {
    EV_ID = setInterval(evolve, EV_TIMEOUT);

    LAST_START = get_timestamp();
    LAST_COUNTER = COUNTER_TOTAL;

    hide("start");
    show("stop");
}

function get_timestamp() {
    return 0.001*(new Date).getTime();
}


//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function setMutation(m) {
    var trans = { 'genetic':[genetic,"b_mut_genetic"], 'gradient':[gradient,"b_mut_gradient"], 'sa':[sa,"b_mut_sa"]};
    mutateDNA = trans[m][0];
    setButtonHighlight(trans[m][1], ["b_mut_genetic", "b_mut_gradient", "b_mut_sa"]);
}


//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

function redrawDNA() {
    drawDNA(CONTEXT_TEST, DNA_TEST);
    drawDNA(CONTEXT_BEST, DNA_BEST);
}

function render_nice_time(s) {
    if(s<60) {
        return Math.floor(s).toFixed(0)+"s";
    }
    else if(s<3600) {
        var m = Math.floor(s/60);
        return m+"m"+" "+render_nice_time(s-m*60);
    }
    else if(s<86400) {
        var h = Math.floor(s/3600);
        return h+"h"+" "+render_nice_time(s-h*3600);
    }
    else {
        var d = Math.floor(s/86400);
        return d+"d"+" "+render_nice_time(s-d*86400);
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function drawShape(ctx, shape, color) {
    ctx.fillStyle = "rgba("+color.r+","+color.g+","+color.b+","+color.a+")";
    ctx.beginPath();
    ctx.moveTo(shape[0].x, shape[0].y);
    for(var i=1;i<ACTUAL_POINTS;i++) {
        ctx.lineTo(shape[i].x, shape[i].y);
    }
    ctx.closePath();
    ctx.fill();
}

function drawDNA(ctx, dna) {
    ctx.fillStyle = "rgb(255,255,255)";
    ctx.fillRect(0, 0, IWIDTH, IHEIGHT);
    for(var i=0;i<ACTUAL_SHAPES;i++) {
        drawShape(ctx, dna[i].shape, dna[i].color);
    }
}


//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function genetic(dna_out) {
    CHANGED_SHAPE_INDEX = rand_int(ACTUAL_SHAPES-1);

    var roulette = rand_float(2.0);

    // mutate color
    if(roulette<1) {
        // red
        if(roulette<0.25) {
            dna_out[CHANGED_SHAPE_INDEX].color.r = rand_int(255);
        }
        // green
        else if(roulette<0.5) {
            dna_out[CHANGED_SHAPE_INDEX].color.g = rand_int(255);
        }
        // blue
        else if(roulette<0.75) {
            dna_out[CHANGED_SHAPE_INDEX].color.b = rand_int(255);
        }
        // alpha
        else if(roulette<1.0) {
            dna_out[CHANGED_SHAPE_INDEX].color.a = rand_float(1.0);
        }
    }

    // mutate shape
    else {
        var CHANGED_POINT_INDEX = rand_int(ACTUAL_POINTS-1);

        // x-coordinate
        if(roulette<1.5) {
            dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].x = rand_int(IWIDTH);
        }

        // y-coordinate
        else {
            dna_out[CHANGED_SHAPE_INDEX].shape[CHANGED_POINT_INDEX].y = rand_int(IHEIGHT);
        }
    }
}



function compute_fitness(dna) {
    var fitness = 0;

    DATA_TEST = CONTEXT_TEST.getImageData(0, 0, IWIDTH, IHEIGHT).data;

    for(var i=0;i<SUBPIXELS;++i) {
        if(i%DEPTH!=3)
            fitness += Math.abs(DATA_INPUT[i]-DATA_TEST[i]);
    }

    return fitness;
}

function pass_gene_mutation(dna_from, dna_to, gene_index) {
    dna_to[gene_index].color.r = dna_from[gene_index].color.r;
    dna_to[gene_index].color.g = dna_from[gene_index].color.g;
    dna_to[gene_index].color.b = dna_from[gene_index].color.b;
    dna_to[gene_index].color.a = dna_from[gene_index].color.a;

    for(var i=0;i<MAX_POINTS;i++) {
        dna_to[gene_index].shape[i].x = dna_from[gene_index].shape[i].x;
        dna_to[gene_index].shape[i].y = dna_from[gene_index].shape[i].y;
    }
}

function copyDNA(dna_from, dna_to) {
    for(var i=0;i<MAX_SHAPES;i++)
        pass_gene_mutation(dna_from, dna_to, i);
}

function evolve() {
    mutateDNA(DNA_TEST);
    drawDNA(CONTEXT_TEST, DNA_TEST);

    FITNESS_TEST = compute_fitness(DNA_TEST);

    if(FITNESS_TEST<FITNESS_BEST) {
        pass_gene_mutation(DNA_TEST, DNA_BEST, CHANGED_SHAPE_INDEX);

        FITNESS_BEST = FITNESS_TEST;
        FITNESS_BEST_NORMALIZED = 100*(1-FITNESS_BEST/NORM_COEF);
        EL_FITNESS.innerHTML = FITNESS_BEST_NORMALIZED.toFixed(2)+"%";

        COUNTER_BENEFIT++;
        EL_STEP_BENEFIT.innerHTML = COUNTER_BENEFIT;

        drawDNA(CONTEXT_BEST, DNA_BEST);
    }
    else {
        pass_gene_mutation(DNA_BEST, DNA_TEST, CHANGED_SHAPE_INDEX);
    }

    COUNTER_TOTAL++;
    EL_STEP_TOTAL.innerHTML = COUNTER_TOTAL;

    if(COUNTER_TOTAL%10==0) {
        var passed = get_timestamp() - LAST_START;
        EL_ELAPSED_TIME.innerHTML = render_nice_time(ELAPSED_TIME+passed);
    }
    if(COUNTER_TOTAL%50==0) {
        var mutsec = (COUNTER_TOTAL-LAST_COUNTER)/(get_timestamp() - LAST_START);
        EL_MUTSEC.innerHTML = mutsec.toFixed(1);
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function init_dna(dna) {
    for(var i=0;i<MAX_SHAPES;i++) {
        var points = new Array(MAX_POINTS);
        for(var j=0;j<MAX_POINTS;j++) {
            points[j] = {'x':rand_int(IWIDTH),'y':rand_int(IHEIGHT)};
        }
        var color = {};
        if(INIT_TYPE=="random")
            color = {'r':rand_int(255),'g':rand_int(255),'b':rand_int(255),'a':0.001};
        else
            color = {'r':INIT_R,'g':INIT_G,'b':INIT_B,'a':INIT_A};
        var shape = {
        'color':color,
        'shape':points
        }
        dna[i] = shape;
    }
}

function extend_dna_polygons(dna) {
    var points = new Array(MAX_POINTS);
    for(var j=0;j<MAX_POINTS;j++) {
        points[j] = {'x':rand_int(IWIDTH),'y':rand_int(IHEIGHT)};
    }
    var color = {};
    if(INIT_TYPE=="random")
        color = {'r':rand_int(255),'g':rand_int(255),'b':rand_int(255),'a':0.001};
    else
        color = {'r':INIT_R,'g':INIT_G,'b':INIT_B,'a':INIT_A};
    var shape = {'color':color, 'shape':points};
    dna.push(shape);
}

function extend_dna_vertices(dna) {
    for(var i=0;i<MAX_SHAPES;i++) {
        var point = {'x':rand_int(IWIDTH),'y':rand_int(IHEIGHT)};
        dna[i].shape.push(point);
    }
}

//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function init_canvas() {
    CANVAS_INPUT = document.getElementById('canvas_input');
    CONTEXT_INPUT = CANVAS_INPUT.getContext('2d');

    CANVAS_TEST = document.getElementById('canvas_test');
    CONTEXT_TEST = CANVAS_TEST.getContext('2d');

    CANVAS_BEST = document.getElementById('canvas_best');
    CONTEXT_BEST = CANVAS_BEST.getContext('2d');

    IWIDTH = IMAGE.width;
    IHEIGHT = IMAGE.height;

    SUBPIXELS = IWIDTH*IHEIGHT*DEPTH;
    NORM_COEF = IWIDTH*IHEIGHT*3*255;

    CANVAS_INPUT.setAttribute('width',IWIDTH);
    CANVAS_INPUT.setAttribute('height',IHEIGHT);

    CANVAS_TEST.setAttribute('width',IWIDTH);
    CANVAS_TEST.setAttribute('height',IHEIGHT);

    CANVAS_BEST.setAttribute('width',IWIDTH);
    CANVAS_BEST.setAttribute('height',IHEIGHT);

    // draw the image onto the canvas
    CONTEXT_INPUT.drawImage(IMAGE, 0, 0, IWIDTH, IHEIGHT);

    DATA_INPUT = CONTEXT_INPUT.getImageData(0, 0, IWIDTH, IHEIGHT).data;

    EL_STEP_TOTAL = document.getElementById("step_total");
    EL_STEP_BENEFIT = document.getElementById("step_benefit");
    EL_FITNESS = document.getElementById("fitness");
    EL_ELAPSED_TIME = document.getElementById("time");
    EL_MUTSEC = document.getElementById("mutsec");

    init_dna(DNA_TEST);
    init_dna(DNA_BEST);
    copyDNA(DNA_BEST, DNA_TEST);

    redrawDNA();
}



function set_example_image(lnk) {
    if(lnk) {
        var el = document.getElementById("imgurl");
        el.value = lnk.href;
        IMAGE.src = lnk.href;
        IMAGE.onload = function() {
            // hack around onload bug
            if(IMAGE.complete) {
                init_canvas();
            }
            else {
                setTimeout(init_canvas, 100);
            }
        }
    }
}


//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
function init() {
    IMAGE.onload = function() {
        if(IMAGE.complete) {
            init_canvas();
        }
        else {
            setTimeout(init_canvas, 100);
        }
    }
    IMAGE.src = IMG_INIT;

}
</script>

<body onload="init()">
    <div class="image">
        Original<br/>
        <canvas id="canvas_input"></canvas>
    </div>

    <div class="image">
        Best<br/>
        <canvas id="canvas_best"></canvas>
    </div>

    <div class="image">
        Evolving<br/>
        <canvas id="canvas_test"></canvas>
    </div>

    <div id="fitwrap">
        <span id="fitness">?</span> Fitness<br/>
        <span id="step_benefit">0</span> Improvements<br/>
        <span id="step_total">0</span> Mutations<br/>

        <div id="start" onclick="start()">Start</div>
        <div id="stop" onclick="stop()">Stop</div>

        <div id="stats">
            <span id="time">0</span> Elapsed time<br/>
            <span id="mutsec">?</span> Mutations per second<br/>
        </div>
    </div>

    <br class="clr"/>

    <br class="clr"/>

    <div id="mutationtype">
        <div class="parname">Mutation</div>
        <div class="button" id="b_mut_genetic" onclick="setMutation('genetic')">Genetic</div>
        <div class="button" id="b_mut_gradient" onclick="setMutation('gradient')">Genetic with Gradient</div>
        <div class="button" id="b_mut_sa" onclick="setMutation('sa')">Simulate Annealing</div>
    </div>

 
    <br class="clr"/>




 </body>
</html>